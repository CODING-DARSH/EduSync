<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Teacher Dashboard - EduSync</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

  <style>
    :root{
      --black:#000;
      --dark-grey:#111;
      --grey:#2d2d2d;
      --silver:#c0c0c0;
      --accent-blue:#3b82f6;
      --accent-green:#10b981;
      --accent-red:#ef4444;
      --accent-yellow:#f59e0b;
    }
    body{
      background:linear-gradient(135deg,var(--black) 0%,var(--dark-grey) 50%,var(--grey) 100%);
      color:var(--silver); font-family:Inter,system-ui,Arial;
    }
    .glass{ background:rgba(26,26,26,0.8); backdrop-filter:blur(12px); border:1px solid rgba(255,255,255,0.05) }
    .glass-card{ background:rgba(45,45,45,0.6); border:1px solid rgba(255,255,255,0.04); }
    .hover-lift{ transition:all .25s ease }
    .hover-lift:hover{ transform:translateY(-6px); box-shadow:0 20px 40px rgba(0,0,0,0.6) }
    .status-high{ color:var(--accent-red) } .status-medium{ color:var(--accent-yellow)} .status-low{ color:var(--accent-green) }
    .small { font-size:.85rem; color:#9aa0a6 }
    .muted { color:#9aa0a6 }
    
    /* New styles for enhanced UI */
    .gradient-text {
      background: linear-gradient(90deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }
    .card-hover {
      transition: all 0.3s ease;
    }
    .card-hover:hover {
      transform: translateY(-4px);
      box-shadow: 0 10px 25px rgba(0,0,0,0.3);
    }
    .sidebar-item {
      transition: all 0.2s ease;
      border-left: 3px solid transparent;
    }
    .sidebar-item:hover {
      background: rgba(59, 130, 246, 0.1);
      border-left-color: #3b82f6;
    }
    .sidebar-item.active {
      background: rgba(59, 130, 246, 0.15);
      border-left-color: #3b82f6;
    }
    .progress-bar {
      height: 6px;
      border-radius: 3px;
      background: rgba(255,255,255,0.1);
      overflow: hidden;
    }
    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      border-radius: 3px;
      transition: width 0.5s ease;
    }
    .notification-dot {
      position: absolute;
      top: -2px;
      right: -2px;
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: #ef4444;
    }
    .btn-primary {
      background: linear-gradient(90deg, #3b82f6, #6366f1);
      color: white;
      transition: all 0.3s ease;
    }
    .btn-primary:hover {
      opacity: 0.9;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(59, 130, 246, 0.4);
    }
    .assignment-form {
      max-height: 0;
      overflow: hidden;
      transition: max-height 0.5s ease;
    }
    .assignment-form.expanded {
      max-height: 500px;
    }
  </style>
</head>
<body class="min-h-screen antialiased">

<!-- NAV -->
<nav class="fixed top-0 w-full glass z-50 border-b border-white/5">
  <div class="max-w-8xl mx-auto px-4 sm:px-6 lg:px-8">
    <div class="flex items-center justify-between h-16">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-gradient-to-br from-blue-400 to-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg">
          <i class="fa-solid fa-chalkboard-user"></i>
        </div>
        <div>
          <h1 class="text-lg font-bold gradient-text">EduSync</h1>
          <p class="text-xs muted -mt-1">Teacher Portal</p>
        </div>
      </div>

      <div class="flex items-center gap-4">
        <div class="hidden lg:block relative">
          <input id="searchBox" placeholder="Search students, courses..." class="glass-card px-4 py-2 rounded-lg text-silver placeholder:muted w-64 focus:outline-none focus:ring-2 focus:ring-blue-500/50" />
          <i class="fa-solid fa-search absolute right-3 top-2.5 text-gray-400"></i>
        </div>
        <button id="refreshMlBtn" class="glass-card px-4 py-2 rounded-lg hover-lift small flex items-center gap-2">
          <i class="fa-solid fa-arrows-rotate"></i>
          Refresh ML
        </button>

        <div class="relative">
          <button class="glass-card p-2 rounded-xl hover-lift relative">
            <i class="fa-solid fa-bell"></i>
            {% if notifications %}<span class="notification-dot"></span>{% endif %}
          </button>
        </div>

        <div class="relative group">
          <div class="glass-card px-3 py-2 rounded-xl flex items-center gap-3 cursor-pointer">
            <img src="https://cdn-icons-png.flaticon.com/512/4140/4140048.png" class="w-8 h-8 rounded-full" />
            <div class="text-right">
              <div class="font-semibold">{{ teacher[1] if teacher else 'Teacher' }}</div>
              <div class="small">ID: {{ teacher[0] if teacher else 'N/A' }}</div>
            </div>
            <i class="fa-solid fa-chevron-down text-xs"></i>
          </div>
          
          <!-- Dropdown menu -->
          <div class="absolute right-0 top-full mt-2 w-48 glass rounded-lg shadow-xl opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-300 z-50">
            <div class="py-2">
              <a href="/teacher/profile" class="block px-4 py-2 text-sm hover:bg-white/5 flex items-center gap-2">
                <i class="fa-solid fa-user w-4"></i>
                Profile
              </a>
              <a href="/teacher/settings" class="block px-4 py-2 text-sm hover:bg-white/5 flex items-center gap-2">
                <i class="fa-solid fa-gear w-4"></i>
                Settings
              </a>
              <div class="border-t border-white/10 my-1"></div>
<form action="/logout" method="POST" class="w-full">
    <button type="submit" class="w-full text-left px-4 py-2 text-sm hover:bg-red-500/20 text-red-400 flex items-center gap-2">
        <i class="fa-solid fa-right-from-bracket w-4"></i>
        Logout
    </button>
</form>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</nav>

<main class="pt-20 pb-12 px-4 max-w-8xl mx-auto">
  <!-- Welcome Header -->
  <section class="mb-8">
    <h1 class="text-2xl font-bold text-white">Welcome back, {{ teacher[1] if teacher else 'Teacher' }}!</h1>
  </section>

  <!-- Top Overview -->
  <section class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
    <div class="glass p-5 rounded-xl card-hover border-l-4 border-blue-500">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-xs muted">Courses</div>
          <div class="text-2xl font-bold text-white">{{ courses|length if courses else 0 }}</div>
        </div>
        <div class="p-2 rounded-lg bg-blue-500/20 text-blue-400">
          <i class="fa-solid fa-book-open"></i>
        </div>
      </div>
      <div class="small mt-2">Active courses</div>
    </div>
    
    <div class="glass p-5 rounded-xl card-hover border-l-4 border-green-500">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-xs muted">Students</div>
          <div class="text-2xl font-bold text-white">{{ students|length if students else 0 }}</div>
        </div>
        <div class="p-2 rounded-lg bg-green-500/20 text-green-400">
          <i class="fa-solid fa-users"></i>
        </div>
      </div>
      <div class="small mt-2">Students under you</div>
    </div>
    
    <div class="glass p-5 rounded-xl card-hover border-l-4 border-yellow-500">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-xs muted">Assignments</div>
          <div class="text-2xl font-bold text-white">{{ assignments|length if assignments else 0 }}</div>
        </div>
        <div class="p-2 rounded-lg bg-yellow-500/20 text-yellow-400">
          <i class="fa-solid fa-file-lines"></i>
        </div>
      </div>
      <div class="small mt-2">Active assignments</div>
    </div>
    
    <div class="glass p-5 rounded-xl card-hover border-l-4 border-red-500">
      <div class="flex justify-between items-start">
        <div>
          <div class="text-xs muted">At-Risk</div>
          <div class="text-2xl font-bold text-white" id="atRiskCount">{{ at_risk_list|length if at_risk_list else 0 }}</div>
        </div>
        <div class="p-2 rounded-lg bg-red-500/20 text-red-400">
          <i class="fa-solid fa-exclamation-triangle"></i>
        </div>
      </div>
      <div class="small mt-2">Predicted at-risk students</div>
    </div>
  </section>

  <div class="grid grid-cols-1 xl:grid-cols-3 gap-6">
    <!-- LEFT (analytics + courses) -->
    <div class="xl:col-span-2 space-y-6">
      <!-- Analytics partial -->
      {% include 'partials/analytics.html' %}

      <!-- Course cards / list -->
      <section class="glass p-6 rounded-xl card-hover">
        <div class="flex justify-between items-center mb-6">
          <h3 class="font-semibold text-white text-lg">Courses Overview</h3>
          <a href="/teacher/courses" class="small muted flex items-center gap-1 hover:text-white transition-colors">
            Manage courses <i class="fa-solid fa-arrow-right text-xs"></i>
          </a>
        </div>
        
        {% if courses %}
        <div class="grid md:grid-cols-2 gap-4">
          {% for course in courses %}
          <div class="glass-card p-4 rounded-lg card-hover">
            <div class="flex justify-between items-start mb-3">
              <div>
                <h4 class="font-semibold text-white">{{ course[1] }}</h4>
                <div class="small muted">ID: {{ course[0] }}</div>
              </div>
              <div class="text-xs px-2 py-1 rounded-full bg-green-500/20 text-green-400 font-medium">Active</div>
            </div>

            <div class="mt-3 small muted flex items-center gap-4">
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-users"></i>
                {% set student_count = [] %}
                {% for student in students %}
                  {% if student[3] == course[0] %}
                    {% set _ = student_count.append(1) %}
                  {% endif %}
                {% endfor %}
                {{ student_count|length }} Students
              </span>
              <span class="flex items-center gap-1">
                <i class="fa-solid fa-file-lines"></i>
                {{ assignments|length }} Assignments
              </span>
            </div>

            <div class="mt-4 flex gap-2">
              <a href="/teacher/course/{{ course[0] }}" class="px-3 py-2 glass-card rounded text-sm flex-1 text-center hover:bg-white/10 transition-colors">
                <i class="fa-solid fa-folder-open mr-1"></i> Open
              </a>
              <a href="/teacher/attendance/{{ course[0] }}" class="px-3 py-2 glass-card rounded text-sm flex-1 text-center hover:bg-white/10 transition-colors">
                <i class="fa-solid fa-clipboard-check mr-1"></i> Attendance
              </a>
              <a href="/teacher/course/{{ course[0] }}/marks" class="px-3 py-2 glass-card rounded text-sm flex-1 text-center hover:bg-white/10 transition-colors">
                <i class="fa-solid fa-pen mr-1"></i> Marks
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
          <i class="fa-solid fa-book-open text-4xl text-gray-600 mb-3"></i>
          <p class="text-gray-500">No courses assigned yet</p>
        </div>
        {% endif %}
      </section>
      
      <!-- Assignments Section -->
      <section class="glass p-6 rounded-xl card-hover">
        <div class="flex items-center justify-between mb-6">
          <h2 class="text-xl font-bold flex items-center gap-2 text-white">
            <i class="fa-solid fa-file-alt text-blue-400"></i>
            My Assignments
          </h2>
          <button id="toggleAssignmentForm" class="text-sm btn-primary px-4 py-2 rounded-lg flex items-center gap-1">
            <i class="fa-solid fa-plus"></i> Create New
          </button>
        </div>

        <!-- Assignment Creation Form -->
        <div id="assignmentForm" class="assignment-form mb-6">
          <form method="POST" action="/teacher/create_assignment" class="glass-card p-4 rounded-xl">
            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="small muted mb-1 block">Assignment Title</label>
                <input name="title" type="text" placeholder="Enter assignment title" required
                       class="w-full px-3 py-2 bg-black/30 rounded-lg border border-silver/20 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white placeholder-gray-500"/>
              </div>
              <div>
                <label class="small muted mb-1 block">Course ID</label>
                <input name="course_id" type="number" placeholder="Enter course ID" required
                       class="w-full px-3 py-2 bg-black/30 rounded-lg border border-silver/20 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white placeholder-gray-500"/>
              </div>
            </div>

            <div class="grid md:grid-cols-2 gap-4 mb-4">
              <div>
                <label class="small muted mb-1 block">Description</label>
                <input name="description" type="text" placeholder="Assignment description"
                       class="w-full px-3 py-2 bg-black/30 rounded-lg border border-silver/20 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white placeholder-gray-500"/>
              </div>
              <div>
                <label class="small muted mb-1 block">Due Date</label>
                <input name="due_date" type="date" required
                       class="w-full px-3 py-2 bg-black/30 rounded-lg border border-silver/20 focus:outline-none focus:ring-2 focus:ring-blue-500/50 text-white"/>
              </div>
            </div>

            <div class="flex gap-2">
              <button type="submit" class="flex-1 py-3 btn-primary rounded-lg font-semibold">
                Create Assignment
              </button>
              <button type="button" id="cancelAssignmentForm" class="px-4 py-3 glass-card rounded-lg font-semibold hover:bg-white/10 transition-colors">
                Cancel
              </button>
            </div>
          </form>
        </div>

        {% if assignments %}
        <div class="space-y-4">
          {% for assignment in assignments %}
          <div class="glass-card p-4 rounded-xl card-hover">
            <div class="flex items-center justify-between mb-3">
              <div>
                <h3 class="font-semibold text-white">{{ assignment[1] }}</h3>
                <p class="text-sm text-silver flex items-center gap-1 mt-1">
                  <i class="fa-solid fa-calendar-day"></i> Due: {{ assignment[2] }}
                </p>
              </div>
              <span class="text-xs px-2 py-1 rounded-full bg-blue-500/20 text-blue-400">
                Active
              </span>
            </div>

            <div class="flex items-center justify-between">
              <div class="flex-1 mr-4">
                <div class="flex justify-between text-xs text-silver mb-1">
                  <span>Submissions</span>
                  <span>0/{{ students|length }}</span>
                </div>
                <div class="progress-bar w-full">
                  <div class="progress-fill" style="width: 0%"></div>
                </div>
              </div>

              <a href="/teacher/submissions/{{ assignment[0] }}"
                 class="px-4 py-2 bg-blue-500/20 text-blue-400 rounded-lg hover:bg-blue-500/30 transition-colors text-sm flex items-center gap-1">
                <i class="fa-solid fa-check"></i> Grade
              </a>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
        <div class="text-center py-8">
          <i class="fa-solid fa-file-alt text-4xl text-gray-600 mb-3"></i>
          <p class="text-gray-500">No assignments created yet</p>
        </div>
        {% endif %}
      </section>
    </div>

    <!-- RIGHT (side panels) -->
    <div class="space-y-6">
      <!-- Risk panel -->
      {% include 'partials/risk_panel.html' %}

      <!-- Calendar -->
      {% include 'partials/calendar_panel.html' %}

      <!-- Activity feed -->
      {% include 'partials/activity_feed.html' %}
    </div>
  </div>

  <!-- Bottom: heatmap + detailed notifications -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mt-6">
    <div class="lg:col-span-2">
      {% include 'partials/heatmap.html' %}
    </div>
    <div>
      <section class="glass p-6 rounded-xl card-hover">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold text-white">Recent Notifications</h3>
          <a href="/teacher/notifications" class="small muted flex items-center gap-1 hover:text-white transition-colors">
            View all <i class="fa-solid fa-arrow-right text-xs"></i>
          </a>
        </div>
        {% if notifications %}
          <div class="space-y-3 max-h-64 overflow-y-auto pr-2">
            {% for n in notifications %}
              <div class="glass-card p-3 rounded-lg card-hover">
                <div class="flex items-start gap-3">
                  <div class="p-2 rounded-lg bg-blue-500/20 text-blue-400 mt-1">
                    <i class="fa-solid fa-bell text-xs"></i>
                  </div>
                  <div>
                    <div class="text-sm text-white">{{ n[0] }}</div>
                    <div class="small muted mt-1">{{ n[1] }}</div>
                  </div>
                </div>
              </div>
            {% endfor %}
          </div>
        {% else %}
          <div class="text-center py-6">
            <i class="fa-solid fa-bell-slash text-2xl text-gray-600 mb-2"></i>
            <p class="text-gray-500">No new notifications</p>
          </div>
        {% endif %}
      </section>
    </div>
  </div>
</main>

<script>
  // Assignment form toggle
  document.getElementById('toggleAssignmentForm').addEventListener('click', function() {
    const form = document.getElementById('assignmentForm');
    form.classList.toggle('expanded');
    this.textContent = form.classList.contains('expanded') ? 'Cancel' : 'Create New';
  });
  
  document.getElementById('cancelAssignmentForm').addEventListener('click', function() {
    document.getElementById('assignmentForm').classList.remove('expanded');
    document.getElementById('toggleAssignmentForm').textContent = 'Create New';
  });

  // helper: fetch ML results and update risk panel
  async function refreshMl() {
    const btn = document.getElementById('refreshMlBtn');
    btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Refreshing...';
    try {
      const res = await fetch('/api/predict_all?notify=false', { method: 'GET' });
      const data = await res.json();
      const atRisk = data.filter(d => d.risk_label === 'high' || d.risk_label === 'medium');
      document.getElementById('atRiskCount').innerText = atRisk.length;

      // update risk list area
      const list = document.getElementById('riskList');
      if (list) {
        list.innerHTML = atRisk.map(s => `
          <div class="p-3 bg-[#111] rounded-lg flex justify-between items-center card-hover">
            <div>
              <div class="font-semibold text-white">${s.name}</div>
              <div class="small muted">Avg: ${s.avg_marks.toFixed(1)} â€¢ Attendance: ${s.attendance_pct.toFixed(1)}%</div>
            </div>
            <div class="text-sm ${s.risk_label==='high'?'status-high':s.risk_label==='medium'?'status-medium':'status-low'} font-bold px-2 py-1 rounded-full bg-opacity-20 ${s.risk_label==='high'?'bg-red-500':s.risk_label==='medium'?'bg-yellow-500':'bg-green-500'}">
              ${s.risk_label.toUpperCase()}
            </div>
          </div>`).join('');
      }
    } catch (e) {
      console.error(e);
    } finally {
      btn.innerHTML = '<i class="fa-solid fa-arrows-rotate"></i> Refresh ML';
    }
  }

  document.getElementById('refreshMlBtn').addEventListener('click', refreshMl);

  // auto-refresh ML every 90 seconds (optional)
  setInterval(refreshMl, 90000);
</script>

<script>
let latestRisk = [];

document.getElementById("scanRisk").onclick = async () => {
  const box = document.getElementById("riskResults");
  box.innerHTML = '<div class="flex justify-center py-4"><i class="fa-solid fa-spinner fa-spin text-blue-400"></i></div>';

  const res = await fetch("/api/risk/scan");
  latestRisk = await res.json();

  let html = `
    <div class="overflow-x-auto mt-2">
      <table class="w-full border border-gray-700 rounded-lg overflow-hidden">
        <thead class="bg-gray-800">
          <tr class="text-gray-300 text-left">
            <th class="p-3"></th>
            <th class="p-3">Name</th>
            <th class="p-3">Risk</th>
            <th class="p-3">Score</th>
            <th class="p-3">Notified?</th>
          </tr>
        </thead>
        <tbody>
  `;

  for (let s of latestRisk) {
    const riskColor = s.risk_label === 'high' ? 'text-red-400' : 
                      s.risk_label === 'medium' ? 'text-yellow-400' : 'text-green-400';
                      
    html += `
      <tr class="border-t border-gray-700 hover:bg-gray-800/50">
        <td class="p-3"><input type="checkbox" value="${s.id}" class="rounded"></td>
        <td class="p-3 text-white">${s.name}</td>
        <td class="p-3 ${riskColor} font-medium">${s.risk_label}</td>
        <td class="p-3">${s.risk_score.toFixed(2)}</td>
        <td class="p-3">${s.notified ? '<span class="text-green-400">YES</span>' : '<span class="text-red-400">NO</span>'}</td>
      </tr>
    `;
  }

  html += "</tbody></table></div>";
  box.innerHTML = html;
};

document.getElementById("sendSelected").onclick = async () => {
  const ids = [...document.querySelectorAll("#riskResults input:checked")]
              .map(ch => Number(ch.value));

  if (ids.length === 0) return alert("No students selected!");

  const res = await fetch("/api/risk/send", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify({ students: ids })
  });

  const j = await res.json();
  alert("Notifications sent: " + j.sent);
};

document.getElementById("resetFlags").onclick = async () => {
  const res = await fetch("/teacher/risk/reset_flags", {method: "POST"});
  const j = await res.json();
  alert(j.message);
};
</script>

</body>
</html>